// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Người dùng và xác thực
model User {
  id                BigInt      @id @default(autoincrement())
  email             String      @unique @db.VarChar(191)
  passwordHash      String?     @db.VarChar(255)
  fullName          String      @db.VarChar(191)
  phone             String?     @db.VarChar(32)
  avatarUrl         String?     @db.VarChar(255)
  role              UserRole    @default(customer)
  provider          AuthProvider @default(local)
  providerId        String?     @db.VarChar(191)
  emailVerifiedAt   DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  addresses         Address[]
  cart              Cart?
  wishlist          Wishlist?
  orders            Order[]
  reviews           Review[]
  passwordResetTokens PasswordResetToken[]

  @@map("users")
  @@index([email])
}

model PasswordResetToken {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model Address {
  id            BigInt   @id @default(autoincrement())
  userId        BigInt
  recipientName String   @db.VarChar(191)
  phone         String   @db.VarChar(32)
  province      String   @db.VarChar(191)
  district      String   @db.VarChar(191)
  ward          String   @db.VarChar(191)
  addressLine   String   @db.VarChar(255)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
  @@index([userId])
}

// Danh mục và sản phẩm
model Category {
  id          BigInt    @id @default(autoincrement())
  parentId    BigInt?
  name        String    @db.VarChar(191)
  slug        String    @unique @db.VarChar(191)
  description String?
  isActive    Boolean   @default(true)
  position    Int       @default(0)

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
  @@index([parentId])
}

model Product {
  id          BigInt   @id @default(autoincrement())
  categoryId  BigInt?
  name        String   @db.VarChar(191)
  slug        String   @unique @db.VarChar(191)
  sku         String?  @db.VarChar(64)
  description String?
  origin      String?  @db.VarChar(191)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category       Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images         ProductImage[]
  variants       ProductVariant[]
  cartItems      CartItem[]
  wishlistItems  WishlistItem[]
  orderItems     OrderItem[]
  reviews        Review[]

  @@map("products")
  @@index([categoryId])
}

model ProductImage {
  id        BigInt @id @default(autoincrement())
  productId BigInt
  imageUrl  String @db.VarChar(255)
  position  Int    @default(0)

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
  @@index([productId])
}

model ProductVariant {
  id             BigInt  @id @default(autoincrement())
  productId      BigInt
  variantName    String  @db.VarChar(191)
  unitLabel      String? @db.VarChar(64)
  price          Decimal @db.Decimal(12, 2)
  compareAtPrice Decimal? @db.Decimal(12, 2)
  stockQuantity  Int     @default(0)
  isActive       Boolean @default(true)

  // Relations
  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems   CartItem[]
  wishlistItems WishlistItem[]
  orderItems  OrderItem[]

  @@map("product_variants")
  @@index([productId])
}

// Giỏ hàng và yêu thích
model Cart {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt?
  sessionId String?  @db.VarChar(191)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  items CartItem[]

  @@map("carts")
  @@unique([userId])
  @@index([userId])
  @@index([sessionId])
}

model CartItem {
  id                BigInt  @id @default(autoincrement())
  cartId            BigInt
  productId         BigInt
  variantId         BigInt?
  quantity          Int
  unitPriceSnapshot Decimal @db.Decimal(12, 2)

  // Relations
  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@map("cart_items")
  @@index([cartId])
}

model Wishlist {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @unique
  createdAt DateTime @default(now())

  // Relations
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items WishlistItem[]

  @@map("wishlists")
}

model WishlistItem {
  id         BigInt   @id @default(autoincrement())
  wishlistId BigInt
  productId  BigInt
  variantId  BigInt?
  createdAt  DateTime @default(now())

  // Relations
  wishlist Wishlist       @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product  Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant  ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([wishlistId, productId, variantId])
  @@map("wishlist_items")
}

// Mã giảm giá
model Coupon {
  id                BigInt      @id @default(autoincrement())
  code              String      @unique @db.VarChar(64)
  type              CouponType
  value             Decimal     @db.Decimal(12, 2)
  minOrderAmount    Decimal?    @db.Decimal(12, 2)
  maxDiscountAmount Decimal?    @db.Decimal(12, 2)
  usageLimit        Int?
  usedCount         Int         @default(0)
  startsAt          DateTime?
  endsAt            DateTime?
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@map("coupons")
}

// Đơn hàng
model Order {
  id                      BigInt        @id @default(autoincrement())
  orderCode               String        @unique @db.VarChar(32)
  userId                  BigInt?
  status                  OrderStatus   @default(PENDING)
  paymentStatus           OrderPaymentStatus @default(UNPAID)
  paymentMethod           PaymentMethod @default(VNPAY)
  subtotalAmount          Decimal       @default(0) @db.Decimal(12, 2)
  discountAmount          Decimal       @default(0) @db.Decimal(12, 2)
  shippingFee             Decimal       @default(0) @db.Decimal(12, 2)
  totalAmount             Decimal       @default(0) @db.Decimal(12, 2)
  shippingAddressSnapshot Json?
  notes                   String?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  // Relations
  user     User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  items    OrderItem[]
  payment  Payment?
  reviews  Review[]

  @@map("orders")
  @@index([userId])
}

model OrderItem {
  id          BigInt  @id @default(autoincrement())
  orderId     BigInt
  productId   BigInt
  variantId   BigInt?
  productName String  @db.VarChar(191)
  variantName String? @db.VarChar(191)
  sku         String? @db.VarChar(64)
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  totalPrice  Decimal @db.Decimal(12, 2)

  // Relations
  order   Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product          @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant?  @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@map("order_items")
  @@index([orderId])
}

// Thanh toán
model Payment {
  id        BigInt        @id @default(autoincrement())
  orderId  BigInt      @unique
  provider PaymentProvider @default(VNPAY)
  amount   Decimal     @db.Decimal(12, 2)
  currency String      @default("VND") @db.Char(3)
  status   PaymentStatus @default(PENDING)
  paidAt   DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  order           Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vnpayTransactions VnpayTransaction[]

  @@map("payments")
}

model VnpayTransaction {
  id                BigInt   @id @default(autoincrement())
  paymentId         BigInt
  vnpTxnRef         String   @db.VarChar(64)
  vnpTransactionNo  String?  @db.VarChar(64)
  vnpAmount         BigInt?
  vnpBankCode       String?  @db.VarChar(32)
  vnpResponseCode   String?  @db.VarChar(16)
  vnpOrderInfo      String?  @db.VarChar(255)
  vnpPayDate        String?  @db.VarChar(14)
  vnpSecureHash     String?  @db.VarChar(255)
  returnParamsRaw   String?
  ipnParamsRaw      String?
  createdAt         DateTime @default(now())

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("vnpay_transactions")
  @@index([paymentId])
  @@index([vnpTxnRef])
}

// Đánh giá
model Review {
  id         BigInt   @id @default(autoincrement())
  userId     BigInt
  productId  BigInt
  orderId    BigInt?
  rating     Int      @db.TinyInt
  comment    String?
  imagesJson Json?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@map("reviews")
  @@index([productId])
  @@index([userId])
}

// Cài đặt hệ thống
model Setting {
  key       String   @id @db.VarChar(128)
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Enums
enum UserRole {
  customer
  admin
}

enum AuthProvider {
  local
  google
}

enum CouponType {
  PERCENT
  FIXED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  SHIPPING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum OrderPaymentStatus {
  UNPAID
  PAID
  FAILED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  COD
  VNPAY
}

enum PaymentProvider {
  VNPAY
  COD
}
